name: Build & Deploy Angular App (Dev)

on:
  push:
    branches: [ dev ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-deploy:
    if: contains(github.event.head_commit.message, 'deploy-dev')   # ‚úÖ Only run when commit message includes 'deploy-dev'
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm ci
        working-directory: ./   # adjust if your Angular project is in a subfolder

      # 4Ô∏è‚É£ Build Angular app for production
      - name: Build Angular app
        run: |
          npm run build -- --configuration production
        working-directory: ./   # adjust if needed

      # 5Ô∏è‚É£ Debug - Verify dist folder
      - name: Debug dist folder
        run: ls -R ./dist || echo "‚ö†Ô∏è Dist folder missing!"
        working-directory: ./   # adjust if needed

      # 6Ô∏è‚É£ Start SSH Agent and add key
      - name: Start SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 7Ô∏è‚É£ Deploy Angular dist to Ubuntu server
      - name: Deploy Angular dist to EC2
        run: |
          echo "üöÄ Connecting to server and deploying files..."
          ssh -i ~/.ssh/github_actions -o StrictHostKeyChecking=no ubuntu@13.232.150.115 "
            sudo mkdir -p /services/frontend &&
            sudo rm -rf /services/frontend/*"

          scp -i ~/.ssh/github_actions -r -o StrictHostKeyChecking=no ./dist/employee-management-ui/* \
            ubuntu@13.232.150.115:/services/frontend/

          ssh -i ~/.ssh/github_actions -o StrictHostKeyChecking=no ubuntu@13.232.150.115 "
            sudo systemctl reload nginx"
